<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>1.3 当我们聊分布式事务，我们在聊什么 &mdash; dolphin</title><link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css"><link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="canonical" href="http://localhost:4000/2021/06/19/1.3-Talk-About-Distribute-Transaction/"><link rel="alternate" type="application/atom+xml" title="dolphin" href="http://localhost:4000/feed.xml"><link rel="shortcut icon" href="http://localhost:4000/favicon.png"><meta property="og:title" content="1.3 当我们聊分布式事务，我们在聊什么"><meta name="keywords" content="分布式, 2PC, 事务, TCC"><meta name="og:keywords" content="分布式, 2PC, 事务, TCC"><meta name="description" content="前言：你是否真的明白分布式事务？"><meta name="og:description" content="前言：你是否真的明白分布式事务？"><meta property="og:url" content="http://localhost:4000/2021/06/19/1.3-Talk-About-Distribute-Transaction/"><meta property="og:site_name" content="dolphin"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-06-19"><title>1.3 当我们聊分布式事务，我们在聊什么 | dolphin</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="1.3 当我们聊分布式事务，我们在聊什么" /><meta name="author" content="DempeZheng" /><meta property="og:locale" content="en_US" /><meta name="description" content="分布式事务" /><meta property="og:description" content="分布式事务" /><link rel="canonical" href="http://localhost:4000/2021/06/19/1.3-Talk-About-Distribute-Transaction/" /><meta property="og:url" content="http://localhost:4000/2021/06/19/1.3-Talk-About-Distribute-Transaction/" /><meta property="og:site_name" content="dolphin" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-19T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="1.3 当我们聊分布式事务，我们在聊什么" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"DempeZheng"},"dateModified":"2021-06-19T00:00:00+08:00","datePublished":"2021-06-19T00:00:00+08:00","description":"分布式事务","headline":"1.3 当我们聊分布式事务，我们在聊什么","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/06/19/1.3-Talk-About-Distribute-Transaction/"},"url":"http://localhost:4000/2021/06/19/1.3-Talk-About-Distribute-Transaction/"}</script> <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="http://localhost:4000/assets/js/jquery-ui.js"></script> <script src="http://localhost:4000/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-RWCQYNELFN"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-RWCQYNELFN'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1> <a href="http://localhost:4000/" title="dolphin"> <span class="octicon octicon-mark-github"></span> dolphin </a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="http://localhost:4000/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small " data-pattern-id="55"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">1.3 当我们聊分布式事务，我们在聊什么</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/06/19 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#技术" title="技术">技术</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 3841 字，约 11 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h2 id="前言你是否真的明白分布式事务">前言：你是否真的明白分布式事务？</h2><ol><li>事务的ACID中的C一致性和分布式CAP理论中C分别是什么，有什么关系？</li><li>分布式环境下，事务的ACID中的原子性通常怎么实现的？隔离性呢？</li><li>分布式事务是一个纯技术问题，为什么很多分布式事务方案会侵入业务？</li></ol><h2 id="从事务acid说起">从事务ACID说起</h2><ul><li>Transaction Atomicity：all-or-nothing<ul><li>undo log</li></ul></li><li>Isolation<ul><li>2PL</li><li>Timestamp Ordering（T/O）<ul><li>Base T/O</li><li>Optimistic Currency Control(OCC)</li><li>Multi-Version Concurrency Control(MVCC)</li></ul></li></ul></li><li>Durability<ul><li>Redo log</li></ul></li><li>Consistency</li></ul><h3 id="思考怎么理解acid中的一致性">思考：怎么理解ACID中的一致性？</h3><blockquote><p>原子性，隔离性和持久性是数据库的属性，而一致性（在ACID意义上）是应用程序的属性。应用可能依赖数据库的原子性和隔离属性来实现一致性，但这并不仅取决于数据库。</p></blockquote><blockquote><p><a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Consistency_(database_systems)">Consistency</a> ensures that a transaction can <strong>only bring the database from one valid state to another</strong>, maintaining database <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Invariant_(computer_science)">invariants</a>: <strong>any data written to the database must be valid according to all defined rules, including <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Integrity_constraints">constraints</a>, <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Cascading_rollback">cascades</a>,<a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Database_trigger">triggers</a>, and any combination thereof.</strong> This prevents database corruption by an illegal transaction, but does <strong>not guarantee that a transaction is \correct.</strong>(From wikipedia)</p></blockquote><h2 id="cap分布式理论">CAP分布式理论</h2><ul><li>Consistency（Linearizability Consistency）<ul><li><a href="https://en.wikipedia.org/wiki/Linearizability">线性一致性 （Linearizability：Strong consistency or Atomic consistency)</a></li><li><a href="https://en.wikipedia.org/wiki/Sequential_consistency">顺序一致性（Sequential consistency）</a></li><li><a href="https://en.wikipedia.org/wiki/Causal_consistency">因果一致性（Causal consistency）</a></li><li><a href="https://en.wikipedia.org/wiki/Eventual_consistency">最终一致性（Eventual consistency）</a></li></ul></li><li>Availability（100% Availability）</li><li>Partition</li></ul><h3 id="思考cap中的c和acid中的c是相同的吗">思考：CAP中的C和ACID中的C是相同的吗？</h3><blockquote><p>Both C’s stand for consistency, but the notion of consistency in CAP means that “all nodes see the same data at the same time” and the notion of consistency in ACID means that “any transaction the database performs will take it from one consistent state to another”. (From Wikipedia.)</p></blockquote><ul><li>ACID C:（multi-object<code class="language-plaintext highlighter-rouge">、</code>multi-operation）</li><li>CAP C: （single-object<code class="language-plaintext highlighter-rouge">、</code>single-operation）多个副本的一致性</li></ul><h2 id="分布式环境给事务带来哪些挑战">分布式环境给事务带来哪些挑战？</h2><h3 id="分布式环境下原子性怎么保证">分布式环境下，原子性怎么保证？</h3><h3 id="2pc原子协议">2PC原子协议</h3><p><img src="http://localhost:4000/images/v2-d40abfa365ed84e84e264ba13900f64b_720w.jpg" alt="img" /></p><p>延伸：<a href="https://zhuanlan.zhihu.com/p/35298019">漫话分布式系统共识协议: 2PC/3PC篇</a></p><p>####</p><h4 id="2pc3pc">2PC→3PC</h4><ul><li>2PC存在什么问题</li><li>3PC解决了什么问题，存在什么问题（为什么很少工程化的实践）</li></ul><h4 id="2pc-vs-paxos">2PC VS Paxos</h4><blockquote><p>2PC blocks if the transaction manager fails, requiring human intervention to restart. 3PC algorithms (there are several such algorithms) try to fix 2PC by electing a new transaction manager when the original manager fails.</p></blockquote><blockquote><p>Paxos does not block as long as a majority of processes (managers) are correct. Paxos actually solves the more general problem of consensus, hence, it can be used to implement transaction commit as well. In comparison to 2PC it requires more messages, but it is resilient to manager failures. In comparison to most 3PC algorithms, Paxos renders a simpler, more efficient algorithm (minimal message delay), and has been proved to be correct.</p></blockquote><blockquote><p>Gray and Lamport compare 2PC and Paxos in an excellent <a href="http://research.microsoft.com/pubs/64636/tr-2003-96.pdf">paper</a> titled “<a href="https://lamport.azurewebsites.net/video/consensus-on-transaction-commit.pdf">consensus on transaction commit</a>”.</p></blockquote><h3 id="isolation--consistency">Isolation &amp; Consistency</h3><p>分布式领域，事务分成了两个子问题，一个是隔离性（isolation），一个是一致性（consistency）</p><p><img src="http://localhost:4000/images/jepsen.png" alt="image.png" /></p><h2 id="xopen-xa">X/Open XA</h2><p>XA 规范 是 X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准。</p><p>XA 规范 描述了全局的事务管理器与局部的资源管理器之间的接口。 XA规范 的目的是允许的多个资源（如数据库，应用服务器，消息队列等）在同一事务中访问，这样可以使 ACID 属性跨越应用程序而保持有效。</p><p>XA 规范 使用两阶段提交（2PC，Two-Phase Commit）来保证所有资源同时提交或回滚任何特定的事务。</p><h3 id="思考xa存在什么问题">思考：XA存在什么问题？</h3><ul><li>提示：2PC存在什么问题？</li><li>锁定引入什么问题？</li></ul><h2 id="柔性事务">柔性事务</h2><ul><li>BASE理论</li><li>非ACID</li></ul><h3 id="思考分布式事务场景acid--cap-怎么选">思考：分布式事务场景，ACID &amp; CAP 怎么选？</h3><ul><li><p>ACID ：Transaction Atomicity： ✅</p></li><li><p>ACID ：Durability： ✅</p></li><li><p>ACID ： Database Consistency： ✅</p></li><li><p>ACID ： <strong>Isolation</strong> ：RU、RC、Cursor Stability、RR、Snapshot Isolation、Serializable ？</p></li><li><p>CAP ： Consistency ：Linearizability、Sequential、Causal、PRAM…?</p></li><li><p>CAP： Availability : 0~100% ?</p></li></ul><h3 id="思考分布式事务场景acid--cap-怎么选隔离性-vs-性能">思考：分布式事务场景，ACID &amp; CAP 怎么选？隔离性 VS 性能</h3><blockquote><p>牺牲隔离性，换取性能</p></blockquote><h2 id="分布式事务解决方案应用层">分布式事务解决方案（应用层）</h2><h3 id="tcc">TCC</h3><p><a href="https://github.com/ningyu1/e-books/blob/master/doc/%E5%A4%A7%E8%A7%84%E6%A8%A1SOA%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86_%E7%A8%8B%E7%AB%8B_SD2C2008.pdf">大规模SOA系统中的分布式事务处理-程立-支付宝</a></p><h3 id="事务消息">事务消息</h3><p><a href="https://help.aliyun.com/document_detail/43348.html">RocketMQ事务消息</a></p><p>【注】Pulsar、Kafka消息中间件的事务支持跟RocketMQ的事务消息有所不同</p><h3 id="可靠消息">可靠消息</h3><p>思考：可靠消息方案的原子性怎么保证？</p><p><a href="https://www.infoq.cn/article/b4vpvp3m8da-pm7zqmgz">去哪儿网消息队列设计与实现</a></p><h3 id="saga">Saga</h3><p><img src="http://localhost:4000/images/From_2PC_To_Saga.png" alt="img" /></p><p><a href="http://seata.io/zh-cn/docs/user/saga.html">SEATA Saga模式</a>、<a href="https://microservices.io/patterns/data/saga.html">Pattern Saga</a></p><h4 id="关于saga">关于Saga</h4><ul><li><code class="language-plaintext highlighter-rouge">Saga</code>区别XA，是基于服务统一排程，而非资源管理器，同TCC；</li><li>Saga区别TCC，没有try步骤，性能优于TCC</li><li>Saga适用长事务（<em>Long</em>-running-transaction），TCC适用短事务</li><li>Saga最大的问题是隔离性带来的问题</li></ul><h4 id="saga-vs-可靠消息">Saga VS 可靠消息</h4><ul><li>可靠消息下游业务不需要Cancel</li><li>可靠消息像是Saga的特例</li></ul><h3 id="其他">其他</h3><ul><li>幂等操作+可回查（叫什么不重要）</li></ul><h3 id="探讨xa-与常见的分布式方案有什么不同">探讨：XA 与常见的分布式方案有什么不同？</h3><p><a href="https://mp.weixin.qq.com/s/uYF7bE9Ob-0hfFVNO7Pcpw">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></p><h2 id="聊一聊seata分布式事务标准化平台">聊一聊：Seata：分布式事务标准化平台</h2><p>思考：</p><ul><li>讨论一个分布式事务框架，我们首先讨论什么？</li><li>性能、业务侵入、隔离性？</li></ul><h2 id="延伸分布式系统设计中capacid可以如何取舍">延伸：分布式系统设计中CAP、ACID可以如何取舍</h2><ol><li>在满足传统数据库的强一致性约束下，我们能做到多高的可用性，以及多低的延迟？</li><li>在满足 100% Read Write Availability 的约束下，我们能做到多高的一致性？</li><li>在这两者之间还存在什么？</li></ol><p>强烈推荐：<a href="http://hcoona.github.io/Tips/CAP-ACID-what-can-we-do/">CAP，ACID，我们能做什么</a></p><h2 id="小结">小结</h2><p>分布式事务没有银弹！分布式事务业务层的解决方案本质是在<strong>性能</strong>、<strong>隔离性</strong>、<strong>业务侵入性</strong>等做取舍。互联网业务场景常常为了高性能而选择牺牲隔离性，通过具体的业务场景或者特定的架构设计去规避隔离性缺失引入的业务问题。所以，很多我们所熟知的分布式事务方案几乎都是限定业务场景的。分布式事务没有银弹！分布式事务业务层的解决方案本质是在性能、隔离性、业务侵入性等做取舍。</p><h2 id="faq">FAQ</h2><h3 id="q1隔离性并发控制分类">Q1：隔离性并发控制分类</h3><p>详见：https://www.zhihu.com/question/60278698</p><h3 id="q2一致性模型线性一致性和顺序一致性的区别">Q2：一致性模型线性一致性和顺序一致性的区别？</h3><p><img src="http://localhost:4000/images/linearizability-5-6979706.png" alt="image" /></p><p>详见：<a href="https://int64.me/2020/%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0.html">一致性模型笔记</a></p><h3 id="q3raft相关">Q3：Raft相关</h3><ul><li>Raft 协议Leader是否一定有最新的数据？<ul><li>是，Leader Completeness</li></ul></li><li>Raft协议判定一个值committed是否一定要等follower ack？<ul><li>否，Entry committed if known to be stored on majority of servers，但是正常流程是等过半数node ack后由Machine State committed，</li></ul></li></ul><p>详见下次技术探讨</p><h2 id="参考文档">参考文档</h2><p><a href="https://plainchant.gitbook.io/plainchant/shu-ju-xing-ying-yong-xi-tong-she-ji/mysql/shen-ru-li-jie-shi-wu">深入理解事务</a></p><p><a href="https://microservices.io/patterns/data/saga.html">Pattern Saga</a></p><p><a href="https://jepsen.io/consistency">consistency</a></p><p><a href="https://ericfu.me/timestamp-in-distributed-trans/">分布式事务中的时间戳</a></p><p><a href="https://marsishandsome.github.io/2019/06/Multi_Version_Concurrency_Control">Multi Version Concurrency Control</a></p></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="http://localhost:4000/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/06/19/1.3-Talk-About-Distribute-Transaction/', clientID: 'Ov23li6FmCJDmAIlZmNK', clientSecret: '81bd012195b582aa2cabb7d2d472dd173353beef', repo: 'blog-comments', owner: 'HeroesZheng', admin: ['HeroesZheng'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="http://localhost:4000/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="DempeZheng">DempeZheng</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="http://localhost:4000/" title="首页" target="">首页</a></li><li> <a href="http://localhost:4000/categories/" title="分类" target="">分类</a></li><li> <a href="http://localhost:4000/wiki/" title="维基" target="">维基</a></li><li> <a href="http://localhost:4000/links/" title="链接" target="">链接</a></li><li> <a href="http://localhost:4000/about/" title="关于" target="">关于</a></li><li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="http://localhost:4000/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
