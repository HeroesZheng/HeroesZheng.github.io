<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>1.5 Fault tolerance and high avaliability &mdash; dolphin</title><link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css"><link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="stylesheet" href="http://localhost:4000/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="http://localhost:4000/2021/11/29/1.4-Fault-tolerance-and-high-avaiability/"><link rel="alternate" type="application/atom+xml" title="dolphin" href="http://localhost:4000/feed.xml"><link rel="shortcut icon" href="http://localhost:4000/favicon.png"><meta property="og:title" content="1.5 Fault tolerance and high avaliability"><meta name="keywords" content="é«˜å¯ç”¨, Leader Election, Log replication, consensus"><meta name="og:keywords" content="é«˜å¯ç”¨, Leader Election, Log replication, consensus"><meta name="description" content="Fault tolerance and high avaliability"><meta name="og:description" content="Fault tolerance and high avaliability"><meta property="og:url" content="http://localhost:4000/2021/11/29/1.4-Fault-tolerance-and-high-avaiability/"><meta property="og:site_name" content="dolphin"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-11-29"><title>1.5 Fault tolerance and high avaliability | dolphin</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="1.5 Fault tolerance and high avaliability" /><meta name="author" content="DempeZheng" /><meta property="og:locale" content="en_US" /><meta name="description" content="é«˜å¯ç”¨" /><meta property="og:description" content="é«˜å¯ç”¨" /><link rel="canonical" href="http://localhost:4000/2021/11/29/1.4-Fault-tolerance-and-high-avaiability/" /><meta property="og:url" content="http://localhost:4000/2021/11/29/1.4-Fault-tolerance-and-high-avaiability/" /><meta property="og:site_name" content="dolphin" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-29T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="1.5 Fault tolerance and high avaliability" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"DempeZheng"},"dateModified":"2021-11-29T00:00:00+08:00","datePublished":"2021-11-29T00:00:00+08:00","description":"é«˜å¯ç”¨","headline":"1.5 Fault tolerance and high avaliability","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/11/29/1.4-Fault-tolerance-and-high-avaiability/"},"url":"http://localhost:4000/2021/11/29/1.4-Fault-tolerance-and-high-avaiability/"}</script> <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="http://localhost:4000/assets/js/jquery-ui.js"></script> <script src="http://localhost:4000/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-RWCQYNELFN"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-RWCQYNELFN'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1> <a href="http://localhost:4000/" title="dolphin"> <span class="octicon octicon-mark-github"></span> dolphin </a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="http://localhost:4000/" class="site-header-nav-item" target="_self" title="ğŸ“°é¦–é¡µ"> <i class="octicon octicon-home"></i> ğŸ“°é¦–é¡µ </a> <a href="http://localhost:4000/categories/" class="site-header-nav-item" target="_self" title="åˆ†ç±»"> <i class="octicon octicon-book"></i> åˆ†ç±» </a> <a href="http://localhost:4000/wiki/" class="site-header-nav-item" target="_self" title="ç»´åŸº"> <i class=""></i> ç»´åŸº </a> <a href="http://localhost:4000/links/" class="site-header-nav-item" target="_self" title="é“¾æ¥"> <i class="octicon octicon-mail"></i> é“¾æ¥ </a> <a href="http://localhost:4000/about/" class="site-header-nav-item" target="_self" title="å…³äº"> <i class="octicon octicon-person"></i> å…³äº </a> <a class="mobile-hidden" href="http://localhost:4000/feed.xml" title="è®¢é˜… RSS"> <i class="octicon octicon-rss" style="color:orange;"></i> </a></nav></div></header><section class="collection-head small " data-pattern-id="55"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">1.5 Fault tolerance and high avaliability</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/11/29 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#æŠ€æœ¯" title="æŠ€æœ¯">æŠ€æœ¯</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> å…± 7946 å­—ï¼Œçº¦ 23 åˆ†é’Ÿ </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="fault-tolerance-and-high-avaliability">Fault tolerance and high avaliability</h1><h2 id="å‰è¨€">å‰è¨€</h2><ul><li>Availability<ul><li>Service-Level Objectiveï¼ˆSLOï¼‰<ul><li>e.g. 99.9% of requests in a day get response in 200 ms</li></ul></li><li>Service-Livel Agreement(SLA)</li></ul></li><li>Achieving high availability : fault tolerance<ul><li>Failure: system as a whole isnâ€™t working</li><li>Fault: some part of system isnâ€™t working<ul><li>Node fault</li><li>Network fault</li></ul></li><li>Fault tolerance</li></ul></li></ul><blockquote><p>Trade-offï¼š performance and consistency</p></blockquote><p>ç‰ºç‰²windowçš„consistencyæ¥æ¢å–æ€§èƒ½ï¼Ÿ</p><blockquote><p>â€œå°‘æ•°æœä»å¤šæ•°â€çš„æ–¹å¼ä¹Ÿæœ‰ä¸€äº›åŠ£åŠ¿ï¼Œä¸ºäº†ä¿è¯ leader é€‰ä¸¾çš„æ­£å¸¸è¿›è¡Œï¼Œå®ƒæ‰€èƒ½å®¹å¿çš„å¤±è´¥çš„ follower æ•°æ¯”è¾ƒå°‘ï¼Œå¦‚æœè¦å®¹å¿ 1 ä¸ª follower æŒ‚æ‰ï¼Œé‚£ä¹ˆè‡³å°‘è¦ 3 ä¸ªä»¥ä¸Šçš„å‰¯æœ¬ï¼Œå¦‚æœè¦å®¹å¿ 2 ä¸ª follower æŒ‚æ‰ï¼Œå¿…é¡»è¦æœ‰ 5 ä¸ªä»¥ä¸Šçš„å‰¯æœ¬ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä¸ºäº†ä¿è¯è¾ƒé«˜çš„å®¹é”™ç‡ï¼Œå¿…é¡»è¦æœ‰å¤§é‡çš„å‰¯æœ¬ï¼Œè€Œå¤§é‡çš„å‰¯æœ¬åˆä¼šåœ¨å¤§æ•°æ®é‡ä¸‹å¯¼è‡´æ€§èƒ½çš„æ€¥å‰§ä¸‹é™ã€‚è¿™ç§ç®—æ³•æ›´å¤šç”¨åœ¨ Zookeeper è¿™ç§å…±äº«é›†ç¾¤é…ç½®çš„ç³»ç»Ÿä¸­è€Œå¾ˆå°‘åœ¨éœ€è¦å¤§é‡æ•°æ®çš„ç³»ç»Ÿä¸­ä½¿ç”¨çš„åŸå› </p></blockquote><h2 id="ç†è®ºåŸºç¡€">ç†è®ºåŸºç¡€</h2><ul><li>RSM</li></ul><p><img src="http://localhost:4000/images/2_2-8189302.png" alt="img" /></p><ul><li><p>Tolerance</p><ul><li><p><strong>Fualt detection</strong></p><ul><li>Typical implementation<ul><li>send messageï¼Œawait responseï¼Œlable node as crashed if no reply within some timeout</li></ul></li><li>Problem<ul><li>cannot tell the difference between crash nodeï¼Œ temporarity unresponsive nodeï¼Œlost messageï¼Œ and delayed message</li></ul></li><li>Failure detection in partially synchronous systems</li></ul></li><li><p><strong>Leader Election</strong></p><ul><li>æ€ä¹ˆé€‰å–æ–°çš„leaderï¼Ÿ</li><li>æ€ä¹ˆä¿è¯æˆ–å°½å¯èƒ½ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</li><li>Follower log repair</li></ul></li><li><p>split-brain</p><blockquote><p>https://en.wikipedia.org/wiki/Split-brain_(computing)</p></blockquote><ul><li><p>Approaches for dealing with split-brain</p><blockquote><p>classify them as either optimistic or pessimistic.</p></blockquote><ul><li>Quorum-consensus</li><li>Fencing</li></ul></li></ul></li><li><p>Log Replication</p><ul><li>Quorums</li><li>Two common approaches<ul><li>Last writer wins(LWW) e.g. lamport clock</li><li>Multi-value register e.g. vector clock</li></ul></li><li>any/one</li><li>ISRï¼ˆIn-Sync Replicasï¼‰</li></ul></li><li><p>Log Compaction</p></li></ul></li></ul><h2 id="å·¥ç¨‹æŠ•å½±">å·¥ç¨‹æŠ•å½±</h2><h3 id="mysql-ha">Mysql HA</h3><p>Mysqlé«˜å¯ç”¨æ¶æ„ï¼šMM keepalived â†’ MHAâ†’Orchestratorâ†’MGR/Galera</p><h4 id="mysql-mha"><a href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Overview">Mysql MHA</a></h4><blockquote><p>MHA performs automating master failover and slave promotion with minimal downtime, usually within 10-30 seconds. MHA prevents replication consistency problems and saves on expenses of having to acquire additional servers. All this with zero performance degradation, no complexity (easy-to-install) and requiring no change to existing deployments.</p></blockquote><p><strong>Failure Detection</strong></p><ul><li><p>MHA Manager checks only single route: From Manager to Master. (By defaultï¼ŒBut this is not recommended. )</p></li><li><p>two or more checking routes by calling an external script defined at <a href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Parameters#secondary_check_script">secondary_check_script</a> parameter</p></li></ul><p><strong>Leader Election</strong></p><p>candidate_master&gt;lastest slave&gt;section name in config file order</p><blockquote><p>If hosts meet the above criteria, new master is determined based on the following rules.</p><ul><li>If you set candidate_master=1 on some hosts, they will be prioritised.<ul><li>If some of them are the latest (slaves that have received the latest binary log events), the host will be selected as a new master</li><li>If multiple hosts are the latest, a master host will be determined by â€œorder by section name in the config fileâ€. If you have server1, server2, and server3 sections and both server1 and server3 are candidate_master and the latest, server1 will be selected as a new master.</li></ul></li><li>If none of servers set candidate_master=1, the latest slave server will be the new master. If multiple slaves are the latest, order by section name rule will be applied.</li><li>If none of the latest slaves can be new master, one of the non-latest slaves will be new master. Order by section name rule will also be applied here.</li><li>If you set <a href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Parameters#latest_priority">latest_priority</a> parameter to 0, â€œwhether the slave is the latest or notâ€ does not matter to decide new master at all. If you want to fully control priorities for the new master (you can decide rules in the config file: order by section name), using this parameter may help.</li></ul></blockquote><p><strong>Brain-Split</strong></p><ul><li>optionally 7-10 seconds to power off the master machine to avoid split brain</li><li>Custom Extensionï¼š<strong><a href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Parameters#shutdown_script">shutdown scprit</a></strong>: For forcing shutdown the master<ul><li>shutdwon process</li><li>power off the machine</li></ul></li></ul><p><em>If shutdown script exit code is other than 0 or 10ï¼ˆfailedï¼‰, MHA Manager aborts failover.</em></p><p><strong>Consistency</strong></p><p>(almost) no data lossï¼ŒBy using together with Semi-Synchronous Replication</p><ul><li>Semi-Synchronous</li><li>prevents replication consistency problems<ol><li>Online switching master to a different hostï¼šblocking writes</li><li>automating master failoverï¼šSaving binary log events from the crashed master (if possible)<ul><li>If the dead master is reachable via SSH, copying binary logs from the latest slaveâ€™s end_log_pos (Read_Master_Log_Pos)</li></ul></li></ol></li></ul><p><strong>RTOï¼ˆRecovery Time Objectiveï¼‰</strong></p><ul><li>æ•…éšœåˆ‡æ¢ï¼š10~30 secondsï¼ˆæœ‰äº›åœºæ™¯æ— æ³•åˆ‡æ¢ï¼‰<ul><li>Failure detectionï¼š 9~12s<ul><li><a href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Parameters#secondary_check_script.md">secondary_check_script</a>: For checking master availability from multiple network routes</li></ul></li><li>avoid split brainï¼š ï¼ˆoptionalï¼‰7~10s</li><li>apply differential relay logs to new masterï¼ša few seconds</li></ul></li><li>æ­£å¸¸åˆ‡æ¢ï¼šwithin mere seconds (0.5-2 seconds) of downtime (blocking writes only)</li></ul><p><strong>å­˜åœ¨çš„é—®é¢˜</strong></p><ul><li>MHA manager å•ç‚¹</li><li>æœ‰äº›åœºæ™¯æ— æ³•è‡ªåŠ¨åˆ‡æ¢ï¼Œå¼ºåˆ¶åˆ‡æ¢å¯èƒ½ä¼šé¢ä¸´æ•°æ®ä¸€è‡´æ€§é—®é¢˜</li><li>brain-splitï¼Œè™½ç„¶MHA shutdown-scriptå¯ä¸€å®šç¨‹åº¦é¿å…è„‘è£‚ï¼Œä½†shutdownæ“ä½œé£é™©è¾ƒå¤§ï¼Œe.g. shutdown new masteråˆ‡æ¢å¤±è´¥ï¼›</li></ul><h4 id="orchestrator"><a href="https://github.com/openark/orchestrator">Orchestrator</a></h4><p>Orchestratorè·ŸMHAæœ¬è´¨ä¸Šç±»ä¼¼ï¼Œç›¸å½“äºæ”¹è‰¯ç‰ˆçš„MHAï¼ˆä¸€å®šç¨‹åº¦ä¸Šä¹Ÿå¼•å…¥äº†å¤æ‚æ€§ï¼‰ï¼Œæœ€æ ¸å¿ƒçš„ç‚¹åœ¨äºå¼•å…¥Raftåè®®ï¼š</p><ul><li><code class="language-plaintext highlighter-rouge">orchestrator/raft</code> deployments solve both high-availability for <code class="language-plaintext highlighter-rouge">orchestrator</code> itself</li><li>as well as solve issues with network isolation, and in particular cross-data-center network partitioning/fencing.è¯¦è§ï¼š<a href="https://github.com/openark/orchestrator/blob/master/docs/raft.md">orchestractor/raft:fencing</a></li></ul><p><a href="https://blog.51cto.com/u_15357073/3799359">MHAä¸Orchestrator å¯¹æ¯”</a></p><p><strong>å­˜åœ¨çš„é—®é¢˜</strong></p><p>Raft consensusåè®®ä¸»è¦æ˜¯è§£å†³orchestratorçš„HAé—®é¢˜ï¼Œå¯¹äºOrchestratorç®¡ç†çš„æ•°æ®åº“Leader Electionå¹¶ä¸æ˜¯é€šè¿‡Raftå®ç°ï¼Œæ‰€ä»¥ä¸€ä¸‹é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼š</p><ul><li>æœ‰äº›åœºæ™¯æ— æ³•æ•…éšœè½¬ç§»ï¼Œå¼ºåˆ¶åˆ‡æ¢å¯èƒ½ä¼šé¢ä¸´æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼›</li><li>è§£å†³è„‘è£‚é—®é¢˜ä»ç„¶æœ‰ä¸€å®šæŒ‘æˆ˜ï¼Œè§£å†³äº†network isolationåœºæ™¯ä¸‹çš„è„‘è£‚ï¼Œä½†æ˜¯æ— æ³•å½»åº•é¿å…è„‘è£‚ï¼›</li></ul><p>å…·ä½“å®è·µè§ï¼š<a href="https://www.infoq.cn/article/mysql-high-availability-at-github">GitHub çš„é«˜å¯ç”¨æ€§æ–¹æ¡ˆï¼šorchestratorã€Consul å’Œ GLB</a></p><h4 id="mysql-group-relication"><a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication.html">Mysql Group Relication</a></h4><p><img src="http://localhost:4000/images/706c2b358669bc1eb2c60e67f88837f5.png" alt="706c2b358669bc1eb2c60e67f88837f5" /></p><blockquote><p>ä¸åŒèŠ‚ç‚¹é—´æ²¡æœ‰åˆ†å¸ƒå¼é”ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨å°é”æ¥é¿å…ã€‚ä¸ºæé«˜æ€§èƒ½ï¼ŒGroup Replicationä¹è§‚åœ°æ¥å¯¹å¾…ä¸åŒäº‹åŠ¡é—´çš„å†²çªï¼Œä¹è§‚çš„è®¤ä¸ºå¤šæ•°äº‹åŠ¡åœ¨æ‰§è¡Œæ—¶æ˜¯æ²¡æœ‰å¹¶å‘å†²çªçš„</p></blockquote><p><img src="http://localhost:4000/images/832b81bca66f0a3fed90b29f582db7f7.png" alt="832b81bca66f0a3fed90b29f582db7f7" /></p><p>####</p><p><strong>ä¸€äº›é™åˆ¶</strong></p><ul><li>Group Replicationä¸­æ¯ä¸ªè¡¨å¿…é¡»å®šä¹‰ä¸€ä¸ªä¸»é”®ï¼Œå‰¯ç»„ç»‡éœ€è¦åˆ©ç”¨å”¯ä¸€å¥æ¥ä½œä¸ºæ¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ ‡è¯†ï¼Œä»è€Œæ˜¯çš„ç»„èƒ½å¤Ÿå‡†ç¡®çš„ç¡®å®šæ¯ä¸ªäº‹åŠ¡ä¿®æ”¹äº†å“ªäº›è¡Œï¼Œä¸€éèƒ½å¤Ÿåˆ¤æ–­å“ªäº›äº‹åŠ¡å­˜åœ¨å†²çª</li><li>äº‹åŠ¡å¤§å°é™åˆ¶ï¼šå¦‚æœäº‹åŠ¡äº§ç”Ÿçš„æ¶ˆæ¯å†…å®¹è¿‡å¤§ï¼Œä»¥è‡³äºé€šè¿‡ç½‘ç»œæ— æ³•åœ¨5så†…åœ¨ç»„æˆå‘˜ä¹‹é—´å¤åˆ¶æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šåˆ¤å®šæˆå‘˜å¤±è´¥ï¼›</li></ul><p><strong>å­˜åœ¨çš„é—®é¢˜ï¼š</strong></p><p>ç½‘ç»œç¯å¢ƒå·®å’Œå¤§äº‹åŠ¡åœºæ™¯ä¸‹è¡¨ç°ä¸å¥½ï¼š</p><ul><li>ä¾èµ–paxos xcomå®ç°consensusï¼ŒåŸå­å¹¿æ’­çš„çªå‡ºä¼˜ç‚¹æ˜¯åœ¨ä½å»¶è¿Ÿå±€åŸŸç½‘æœ‰å¾ˆé«˜çš„ååç‡ã€‚åä¹‹multi-primary modeåœ¨è·¨æœºæˆ¿ä¸ç¨³å®šçš„ç½‘ç»œç¯å¢ƒè¡¨ç°ä¸å¥½</li></ul><blockquote><p>The MySQL Group Replication documentation isnâ€™t very optimistic on WAN support, claiming that both â€œLow latency, high bandwidth network connections are a requirementâ€ and â€œGroup Replication is designed to be deployed in a cluster environment where server instances are very close to each other, and is impacted by both network latency as well as network bandwidth.â€</p></blockquote><ul><li>MGRäº‹åŠ¡è®¤è¯éœ€è¦write_setï¼Œå¤§äº‹åŠ¡æ¶‰åŠçš„write_setè¿‡å¤§ä¹Ÿä¼šå½±å“æ€§èƒ½ï¼Œå®¹æ˜“hungä½ï¼›</li></ul><h3 id="redis-cluster"><a href="https://redis.io/topics/cluster-tutorial">Redis cluster</a></h3><ul><li><p>High performance and linear scalability up to 1000 nodes</p><p><strong>consistency guarantees</strong></p></li><li><p>Redisä¸ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä¸»è¦æ˜¯åŸºäºæ€§èƒ½å’Œä¸€è‡´æ€§çš„å–èˆï¼›</p></li><li><p>Redisæ”¯æŒsynchronous writesï¼Œåœ¨sychronousçš„æ¨¡å‹ä¸‹ï¼Œä»ç„¶ä¸æ”¯æŒå¼ºä¸€è‡´æ€§ï¼›</p></li></ul><blockquote><p>Redis Cluster is not able to guarantee <strong>strong consistency</strong>.</p><p>Basically, there is a trade-off to be made between performance and consistency.</p><p>Redis Cluster has support for synchronous writes when absolutely needed, implemented via the <a href="https://redis.io/commands/wait">WAIT</a> command. This makes losing writes a lot less likely. However, note that Redis Cluster does not implement strong consistency even when synchronous replication is used: it is always possible, under more complex failure scenarios, that a replica that was not able to receive the write will be elected as master.</p></blockquote><p><strong>Failure Detection</strong></p><p>åœ¨ä¸€ä¸ªNodeTimeoutæ—¶é—´ä¹‹åè¿˜æœªæ”¶åˆ°æ–°çš„pingæ¶ˆæ¯ï¼Œå°±ä¼šæ ‡è®°PFailï¼Œå½“é›†ç¾¤ä¸­çš„å¤§å¤šæ•°èŠ‚ç‚¹éƒ½æ ‡è®°PFailï¼Œå°±ä¼šåˆ¤å®šæœªFail</p><ul><li><p>heartbeartï¼šPing/pong</p></li><li><p>gossip</p></li><li><p>PFAIL:prossible failure</p></li><li><p>FAIL:Node is failing, confirmed by a majority of masters within a fixed amount of time.</p></li></ul><p><strong>Leader Election</strong></p><ul><li>epochï¼šlogical clock<ul><li>configEpoch</li><li>repl_offsetï¼šoffsetè¶Šå¤§ï¼Œéšæœºä¼‘çœ çš„æ—¶é—´è¶ŠçŸ­ï¼Œè¶Šæœ‰æœºä¼šè¢«é€‰ä¸¾</li></ul></li><li>majority</li></ul><p><strong>Brain-split</strong></p><p>PFAIL -&gt; FAIL çš„è½¬å˜ä½¿ç”¨ä¸€ç§å¼±åè®®ï¼ˆagreement</p><ul><li>gossip</li><li>epoch</li></ul><h3 id="æ¶ˆæ¯é˜Ÿåˆ—">æ¶ˆæ¯é˜Ÿåˆ—</h3><h4 id="kafka">Kafka</h4><p>Kafkaä¸­Fault Detectionã€Leader Electionä¾èµ–zk</p><p><strong>æ•°æ®å¯é æ€§</strong></p><blockquote><p>é«˜å¯é é…ç½®ï¼š</p><p>topic çš„é…ç½®ï¼šreplication.factor&gt;=3, å³å‰¯æœ¬æ•°è‡³å°‘æ˜¯ 3 ä¸ªï¼›2&lt;=min.insync.replicas&lt;=replication.factor</p><p>broker çš„é…ç½®ï¼šleader çš„é€‰ä¸¾æ¡ä»¶ unclean.leader.election.enable=false(åªæœ‰åœ¨ISRä¸­æ‰å¯ä»¥å‚ä¸é€‰ä¸¾)</p><p>producer çš„é…ç½®ï¼šrequest.required.acks=-1(all)ï¼Œproducer.type=syncï¼ˆISRä¸­çš„æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°æ‰å‘é€ä¸‹ä¸€æ¡ï¼‰</p></blockquote><table><tbody><tr><td>**ISR</td><td>HW</td><td>ACKï¼š**</td></tr></tbody></table><p>å½“request.required.acks=1ï¼ˆé»˜è®¤ï¼‰æ—¶ï¼Œå¦‚æœLeader Aå®•æœºï¼ŒFollow Bè¢«é€‰ä¸¾ä¸ºæ–°çš„leaderï¼Œé‚£ä¹ˆâ€œ6â€ä¼šè¢«ä¸¢å¤±ï¼›</p><p><img src="http://localhost:4000/images/3a63cea8900ea96235171a3d7432d667.jpg" alt="img" /></p><blockquote><p>å¦‚ä¸Šå›¾ï¼ŒæŸä¸ª topic çš„æŸ partition æœ‰ä¸‰ä¸ªå‰¯æœ¬ï¼Œåˆ†åˆ«ä¸º Aã€Bã€Cã€‚A ä½œä¸º leader è‚¯å®šæ˜¯ LEO æœ€é«˜ï¼ŒB ç´§éšå…¶åï¼ŒC æœºå™¨ç”±äºé…ç½®æ¯”è¾ƒä½ï¼Œç½‘ç»œæ¯”è¾ƒå·®ï¼Œæ•…è€ŒåŒæ­¥æœ€æ…¢ã€‚è¿™ä¸ªæ—¶å€™ A æœºå™¨å®•æœºï¼Œè¿™æ—¶å€™å¦‚æœ B æˆä¸º leaderï¼Œå‡å¦‚æ²¡æœ‰ HWï¼Œåœ¨ A é‡æ–°æ¢å¤ä¹‹åä¼šåšåŒæ­¥ (makeFollower) æ“ä½œï¼Œåœ¨å®•æœºæ—¶ log æ–‡ä»¶ä¹‹åç›´æ¥åšè¿½åŠ æ“ä½œï¼Œè€Œå‡å¦‚ B çš„ LEO å·²ç»è¾¾åˆ°äº† A çš„ LEOï¼Œä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œæ‰€ä»¥ä½¿ç”¨ HW æ¥é¿å…è¿™ç§æƒ…å†µã€‚A åœ¨åšåŒæ­¥æ“ä½œçš„æ—¶å€™ï¼Œå…ˆå°† log æ–‡ä»¶æˆªæ–­åˆ°ä¹‹å‰è‡ªå·±çš„ HW çš„ä½ç½®ï¼Œå³ 3ï¼Œä¹‹åå†ä» B ä¸­æ‹‰å–æ¶ˆæ¯è¿›è¡ŒåŒæ­¥ã€‚</p></blockquote><h4 id="pulsar">pulsar</h4><p>Topic Owner â†’ Ledger Client ï¼ˆåªæœ‰ä¸€ä¸ªledger Clientå¯å†™å…¥ï¼‰ï¼ŒLedgeråˆ‡æ¢é€šèƒ½è¿‡fencingæœºåˆ¶é¿å…è„‘è£‚</p><p><strong>fencing</strong></p><p>è¯¦è§ï¼š<a href="https://cwiki.apache.org/confluence/display/BOOKKEEPER/Fencing">BK Fencing</a></p><p><img src="http://localhost:4000/images/fencing-example.png" alt="img" /></p><h3 id="æ¢è®¨">æ¢è®¨</h3><h4 id="æ€è€ƒä¾èµ–zkå®ç°leader-electionæ€ä¹ˆé¿å…è„‘è£‚">æ€è€ƒï¼šä¾èµ–ZKå®ç°Leader Electionï¼Œæ€ä¹ˆé¿å…è„‘è£‚ï¼Ÿ</h4><p>e.g.: Kafka broker æ€ä¹ˆé¿å…è„‘è£‚ï¼Ÿ</p><ol><li>Controllerè¿›è¡ŒFull GCåœé¡¿æ—¶é—´å¤ªé•¿è¶…è¿‡zookeeper session timeout å‡ºç°å‡æ­»</li><li>Controller æ‰€åœ¨brokerç½‘ç»œå‡ºç°æ•…éšœ</li></ol><p>è§£å†³æ–¹æ¡ˆï¼š</p><p>broker leaderä¼šç»´æŠ¤epochï¼Œé€‰ä¸¾æ–°çš„leader epochä¼šé€’å¢ï¼Œå¹¶åŒæ­¥å…¶ä»–çš„followerï¼Œfollowerä¼šæ¥å—epochæ›´æ–°çš„leaderçš„è¯·æ±‚ï¼›</p><p>Kafkaçš„Controllerä¹Ÿé‡‡ç”¨äº†epochï¼Œå…·ä½“æœºåˆ¶å¦‚ä¸‹:</p><ul><li>æ‰€æœ‰Brokerç›‘æ§â€/controllerâ€ï¼ŒèŠ‚ç‚¹è¢«åˆ é™¤åˆ™å¼€å¯æ–°ä¸€è½®é€‰ä¸¾ï¼ŒèŠ‚ç‚¹å˜åŒ–åˆ™è·å–æ–°çš„epoch</li><li>Controllerä¼šæ³¨å†ŒSessionExpiredListenerï¼Œä¸€æ—¦å› ä¸ºç½‘ç»œé—®é¢˜å¯¼è‡´Sessionå¤±æ•ˆï¼Œåˆ™è‡ªåŠ¨ä¸§å¤±Controllerèº«ä»½ï¼Œé‡æ–°å‚ä¸é€‰ä¸¾</li><li>æ”¶åˆ°Controllerçš„è¯·æ±‚ï¼Œå¦‚æœå…¶epochå°äºç°åœ¨å·²çŸ¥çš„controller_epochï¼Œåˆ™ç›´æ¥æ‹’ç»</li></ul><p>ç†è®ºä¸Šæ¥è¯´ï¼Œå¦‚æœControllerçš„SessionExpiredå¤„ç†æˆåŠŸï¼Œåˆ™å¯ä»¥é¿å…åŒleaderï¼Œä½†å‡è®¾SessionExpireå¤„ç†æ„å¤–å¤±æ•ˆçš„æƒ…å†µï¼šæ—§Controllerå‡æ­»ï¼Œæ–°çš„Controlleråˆ›å»ºã€‚æ—§Controllerå¤æ´»ï¼ŒSessionExpiredå¤„ç†<strong>æ„å¤–å¤±æ•ˆ</strong>ï¼Œä»ç„¶è®¤ä¸ºè‡ªå·±æ˜¯leaderã€‚ è¿™æ—¶è™½ç„¶æœ‰ä¸¤ä¸ªleaderï¼Œä½†æ²¡æœ‰å…³ç³»ï¼Œleaderåªä¼šå‘ä¿¡æ¯ç»™å­˜æ´»çš„brokerï¼ˆä»ç„¶ä¸Zookeeperåœ¨Sessionå†…çš„ï¼‰ï¼Œè€Œè¿™äº›å­˜æ´»çš„brokeråˆ™è‚¯å®šèƒ½æ„ŸçŸ¥åˆ°æ–°leaderçš„å­˜åœ¨ï¼Œæ—§leaderçš„è¯·æ±‚ä¼šè¢«æ‹’ç»</p><p>ã€æ³¨ã€‘åœ¨ä¸€ä¸ªç‰¹å®šçš„windowä»ç„¶å¯èƒ½ä¼šæœ‰è„‘è£‚çš„å¯èƒ½ï¼Œè¦å®Œå…¨é¿å…è„‘è£‚è¦ä¹ˆè¯·æ±‚æ¯æ¬¡ä»zké‡Œé¢è·å–æœ€æ–°çš„leaderä¿¡æ¯ï¼Œè¦ä¹ˆbrokerè‡ªèº«å®ç°å…±è¯†åè®®ï¼›</p><ul><li>ZK &amp; HDFSæ€ä¹ˆé¿å…è„‘è£‚çš„å‘¢ï¼Ÿ</li></ul><h2 id="å°ç»“å½“æˆ‘ä»¬è°ˆé«˜å¯ç”¨çš„æ—¶å€™æˆ‘ä»¬å†è°ˆä»€ä¹ˆ">å°ç»“ï¼šå½“æˆ‘ä»¬è°ˆé«˜å¯ç”¨çš„æ—¶å€™æˆ‘ä»¬å†è°ˆä»€ä¹ˆ</h2><ul><li><p>æ•…éšœæ¢å¤æ—¶é—´ï¼ˆRPOï¼‰</p><ul><li>æ•…éšœæ¢æµ‹<ul><li>Timeout<ul><li>More: select or write</li></ul></li><li>harnesses the replication topology</li></ul></li><li>avoid brain-split</li></ul></li><li><p>Performance</p></li><li><p>æ•°æ®ä¸€è‡´æ€§ï¼ˆRTOï¼‰</p><ul><li>Leader Electionï¼š<ul><li>consensusåè®®ï¼šä¿è¯æ–°çš„leaderæœ‰committedçš„æ•°æ®</li><li>promote a candidate master</li><li>Lastest slave</li></ul></li></ul></li><li><p>brain-split</p><ul><li>Quorum-consensus</li><li>Fencing</li></ul></li><li><p>å…¶ä»–</p><ul><li>æœºå™¨æˆæœ¬</li><li>è¿ç»´æˆæœ¬</li></ul></li></ul><h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2><p><a href="https://redis.io/topics/cluster-tutorial">Redis cluster tutorial</a></p><p><a href="http://www.redis.cn/topics/cluster-spec">Redisé›†ç¾¤è§„èŒƒ</a></p><p><a href="https://www.infoq.cn/article/depth-interpretation-of-kafka-data-reliability">Kafka æ•°æ®å¯é æ€§æ·±åº¦è§£è¯»</a></p><p><a href="http://mysql.taobao.org/monthly/2017/08/01/">MySQL Â· å¼•æ“ç‰¹æ€§ Â· Group Replicationå†…æ ¸è§£æ</a></p><p><a href="https://cwiki.apache.org/confluence/display/BOOKKEEPER/Fencing">BK Fencing</a></p></article><div class="share"><div class="share-component" data-disabled='qq,douban,qzone,linkedin'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="http://localhost:4000/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/11/29/1.4-Fault-tolerance-and-high-avaiabili', clientID: 'Ov23li6FmCJDmAIlZmNK', clientSecret: '81bd012195b582aa2cabb7d2d472dd173353beef', repo: 'blog-comments', owner: 'HeroesZheng', admin: ['HeroesZheng'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="http://localhost:4000/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> Â© 2015 <span title="DempeZheng">DempeZheng</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="http://localhost:4000/" title="ğŸ“°é¦–é¡µ" target="">ğŸ“°é¦–é¡µ</a></li><li> <a href="http://localhost:4000/categories/" title="åˆ†ç±»" target="">åˆ†ç±»</a></li><li> <a href="http://localhost:4000/wiki/" title="ç»´åŸº" target="">ç»´åŸº</a></li><li> <a href="http://localhost:4000/links/" title="é“¾æ¥" target="">é“¾æ¥</a></li><li> <a href="http://localhost:4000/about/" title="å…³äº" target="">å…³äº</a></li><li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="å›åˆ°é¡¶éƒ¨"><span class="octicon octicon-arrow-up"></span></a></div><script src="http://localhost:4000/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="http://localhost:4000/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
