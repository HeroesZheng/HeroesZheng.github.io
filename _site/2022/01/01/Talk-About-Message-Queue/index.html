<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>当我们聊消息队列，我们在聊什么 &mdash; dolphin</title><link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css"><link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="canonical" href="http://localhost:4000/2022/01/01/Talk-About-Message-Queue/"><link rel="alternate" type="application/atom+xml" title="dolphin" href="http://localhost:4000/feed.xml"><link rel="shortcut icon" href="http://localhost:4000/favicon.ico"><meta property="og:title" content="当我们聊消息队列，我们在聊什么"><meta name="keywords" content="pulsar, message queue, stream, log"><meta name="og:keywords" content="pulsar, message queue, stream, log"><meta name="description" content="当我们聊消息队列，我们在聊什么"><meta name="og:description" content="当我们聊消息队列，我们在聊什么"><meta property="og:url" content="http://localhost:4000/2022/01/01/Talk-About-Message-Queue/"><meta property="og:site_name" content="dolphin"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2022-01-01"><title>当我们聊消息队列，我们在聊什么 | dolphin</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="当我们聊消息队列，我们在聊什么" /><meta name="author" content="DempeZheng" /><meta property="og:locale" content="en_US" /><meta name="description" content="消息队列" /><meta property="og:description" content="消息队列" /><link rel="canonical" href="http://localhost:4000/2022/01/01/Talk-About-Message-Queue/" /><meta property="og:url" content="http://localhost:4000/2022/01/01/Talk-About-Message-Queue/" /><meta property="og:site_name" content="dolphin" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-01T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="当我们聊消息队列，我们在聊什么" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"DempeZheng"},"dateModified":"2022-01-01T00:00:00+08:00","datePublished":"2022-01-01T00:00:00+08:00","description":"消息队列","headline":"当我们聊消息队列，我们在聊什么","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2022/01/01/Talk-About-Message-Queue/"},"url":"http://localhost:4000/2022/01/01/Talk-About-Message-Queue/"}</script> <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="http://localhost:4000/assets/js/jquery-ui.js"></script> <script src="http://localhost:4000/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="http://localhost:4000/" title="dolphin"><span class="octicon octicon-mark-github"></span> dolphin</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="http://localhost:4000/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small " data-pattern-id="55"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">当我们聊消息队列，我们在聊什么</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2022/01/01 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#技术" title="技术">技术</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2925 字，约 9 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="当我们聊消息队列我们在聊什么">当我们聊消息队列，我们在聊什么</h1><h2 id="一what-is-messaging">一、What is messaging</h2><h3 id="request-response模式">request-response模式</h3><p>本地系统（client）与通过远程系统（server）暴露的通信终端进行同步通讯。在形式上无论是远程系统调用，还是web service调用，或者是远程资源的消费，这些在本质上都是一个模型，只是表现形式不同：本地系统向远程系统发送消息，本地系统同步等待远程系统返回应答，系统之间通过点对点的方式通讯。</p><p><img src="https://static.packt-cdn.com/products/9781783983209/graphics/3209OS_01_01.jpg" alt="img" /></p><h3 id="one-way-style模型">one way style模型</h3><p>在one way style方式中，系统之间通过传递消息的方式异步交互，所谓异步也就是系统A在发送完消息之后不需要同步等待系统B的应答。</p><p><img src="https://static.packt-cdn.com/products/9781783983209/graphics/3209OS_01_02.jpg" alt="img" /></p><h3 id="loosely-coupled模型">loosely coupled模型</h3><p>在one way style方式中，系统之间通过传递消息的方式异步交互，所谓异步也就是系统A在发送完消息之后不需要同步等待系统B的应答。</p><p><img src="https://static.packt-cdn.com/products/9781783983209/graphics/3209OS_01_10.jpg" alt="img" /></p><h3 id="消息传递模型">消息传递模型</h3><p>在实时流式架构中，消息传递能够分为两类：队列（Queue）和流（Stream）。</p><h4 id="队列queue模型">队列（Queue）模型</h4><p>A <strong>*queue*</strong> is a simple FIFO mechanism allowing you to add items to the back of the queue or take from the front.</p><ul><li>消息只能被消费一次</li><li>消息不能被回溯</li><li>通常和生产消费者模式一起</li></ul><h4 id="流式stream模型">流式（Stream）模型</h4><p>A <strong>*stream*</strong> is not really a data structure as such (conceptually), but is a sequence of digitally encoded coherent signals (packets of data or data packets) used to transmit or receive information”. So basically a sequence of data.</p><ul><li>Streams always have a source</li><li>stream processing</li><li>With Pub/Sub pattern</li></ul><blockquote><p>In stream processing, you apply complex operations on multiple input streams and multiple records (ie, messages) at the same time (like aggregations and joins).</p></blockquote><h4 id="queue--stream">Queue &amp; Stream</h4><p>当前的分布式消息中间件几乎很多都不单纯是消息队列，还提供流式处理的能力，例如kafka，不仅可以发布订阅stream，还可以存储记录，甚至可以做一些简单的streamprocessing。而Apache pulsar直接在消费模型上面，讲queue和stream统一起来都实现了。queue和stream虽然有一些不同，但是界限变得越来越模糊了。</p><h2 id="二why-message-queue">二、Why message queue</h2><p>消息队列的作用：</p><ul><li><p>异步</p></li><li><p>解耦</p></li><li><p>削峰</p></li></ul><p>disadvantage：</p><ul><li><p>maintain message queue</p><ul><li><p>Consume same message twice</p></li><li><p>Lose message</p></li></ul></li><li><p>Inconsistency</p></li><li><p>Availability</p></li></ul><h2 id="三reliability">三、Reliability</h2><ul><li><p>producer→Broker→Consumer 链路可靠</p><ul><li><p>producer：幂等重试</p></li><li><p>Broker：消息可靠存储</p><ul><li><p>消息持久化</p></li><li><p>多副本</p></li><li><p>故障转移</p></li></ul></li><li><p>Consumer： Ack机制</p><ul><li><p>业务幂等</p></li><li><p>Ack机制</p></li></ul></li></ul></li></ul><h2 id="四-availabilty">四、 Availabilty</h2><ul><li><p>Broker无状态</p></li><li><p>Message Store多副本</p></li><li><p>故障自动转移</p></li></ul><h2 id="五performance">五、Performance</h2><ul><li><p>顺序写入</p></li><li><p>partition</p></li><li><p>批量</p></li><li><p>I/O 分离</p></li><li><p>cache</p><ul><li><p>broker cache</p></li><li><p>page cache</p></li><li><p>Log cache</p></li></ul></li><li><p>zero copy</p></li><li><p>数据压缩</p></li></ul><p>良好设计的消息队列，系统的吞吐取决于网卡，如何设计出低延迟的消息系统也很关键；</p><p><strong>Low latency：</strong></p><ul><li><p>tailing read</p><ul><li><p>cache</p></li><li><p>并行读</p></li></ul></li><li><p>write</p><ul><li>WAL</li></ul></li></ul><h2 id="六how-message-queue-design">六、（How） Message queue Design</h2><h3 id="message-queue">Message Queue</h3><ul><li><p>Queue implements <em>load balancer</em> semantics. A single message will be received by exactly one consumer.</p></li><li><p>点对点（point-to-point）</p></li></ul><p><strong>disadvantage</strong>：</p><ul><li><p>point-to-point（1→1），多个消费者需要多个message queue</p></li><li><p>下游增加消费者，需要上游添加message queue</p></li></ul><p><img src="http://localhost:4000/images/2022-01-05-17-45-34-image.png" alt="" /></p><h3 id="topic">Topic</h3><ul><li><p>Topic implements <em>publish and subscribe</em> semantics</p></li><li><p>publisher-subscriber model</p></li><li><p>publish-and-subcribe（1→many）</p></li></ul><h4 id="镜像queue">镜像queue</h4><ul><li>不同的subscription使用不同的镜像queue，存储不同</li></ul><p><strong>disadvantage</strong>：</p><ul><li>数据冗余，有一定存储和性能浪费</li></ul><p><img src="http://localhost:4000/images/2022-01-05-17-31-09-image.png" alt="" /></p><h4 id="cursor">Cursor</h4><ul><li><p>同一份数据存储</p></li><li><p>subscription维护各自的Cursor（消费游标）</p></li></ul><p><img src="http://localhost:4000/images/2022-01-05-17-31-25-image.png" alt="" /></p><h3 id="partition-topic">Partition Topic</h3><p>单个Topic存在的问题：</p><ul><li>topic过大，broker &amp; store 存在瓶颈</li></ul><p>解决方案：</p><ul><li><p>拆分成多个partition</p></li><li><p>partition是逻辑分片，对业务透明</p></li></ul><p><img src="http://localhost:4000/images/2022-01-05-17-31-42-image.png" alt="" /></p><h2 id="计算和存储分离">计算和存储分离</h2><ul><li><p>Broker状态</p></li><li><p>Topic Store水平扩展</p></li></ul><p>【注】多一层会额外引入性能损耗&amp;系统复杂性</p><p><img src="http://localhost:4000/images/2022-01-05-17-31-56-image.png" alt="" /></p><h3 id="topic-store--distribute-log">Topic Store ： Distribute Log</h3><ol><li><p>Message queue可以看作是一组有序的数据流（Stream）；</p></li><li><p>日志是一种简单的抽象，只能追加，按时间有序的序列；</p></li><li><p>日志是持久化的数据流；</p></li><li><p>Topic Store核心是日志，分布式消息队列的底层存储是Distribute Log System；</p></li></ol><p><img src="http://localhost:4000/images/2022-01-05-17-32-12-image.png" alt="loading-ag-3482" /></p><p><img src="/image-20211202164512736.png" alt="image20211202164512736" /></p><h4 id="log-workloads-low-latencyhigh-throughput">Log workloads： low latency，High throughput</h4><p>日志系统的核心负载可以归为三类：writes，tailing reads，catch-up reads</p><p>Writes 和 tailing reads 在意的是延时 (latency)，因为它关系到一个消息能多快地从被写入到被读到。</p><p>而 catch-up reads 在意的则是高吞吐量，因为它关系到是否能追赶到日志的尾部。</p><p><img src="http://localhost:4000/images/2022-01-05-17-33-22-image.png" alt="" /></p><ul><li><p>tailing reads： log cache &amp; broker cache &amp;page cache</p><ul><li>catch-up reads可能会造成cache污染</li></ul></li><li><p>writes： append only</p><ul><li><p>topic维度的顺序写</p></li><li><p>Write Ahead Log</p></li></ul></li><li><p>catch-up reads</p><ul><li>避免污染cache</li></ul></li></ul><h4 id="工程投影分布式日志系统bookeeper">工程投影：分布式日志系统Bookeeper</h4><p><img src="https://dolphin7.xyz/images/bk1.png" alt="bk1" /></p><h3 id="高级功能">高级功能</h3><ul><li>顺序保证<ul><li>单个partition有序</li></ul></li><li>延迟队列</li><li>事务消息</li><li>跨地域复制</li><li>多租户<ul><li>租户隔离</li><li>租户调整有挑战</li></ul></li><li>消息语义保证<ul><li>at least once</li><li>at most once</li><li>extractly once</li></ul></li></ul><h2 id="参考文档">参考文档：</h2><p><a href="https://alexstocks.github.io/html/pulsar.html">pulsar笔记</a></p><p><a href="https://mp.weixin.qq.com/s/CIpCLCxqpLoQVUKz6QeDJQ">理解Apache Pulsar工作原理</a></p><p><a href="[translations/part1-what-is-a-log.md at master · oldratlee/translations · GitHub](https://github.com/oldratlee/translations/blob/master/log-what-every-software-engineer-should-know-about-real-time-datas-unifying/part1-what-is-a-log.md)">日志是什么</a></p><p><a href="https://mp.weixin.qq.com/s/0dkgA8swNPkpcY5H6CU62w">Twitter高性能分布式日志系统架构解析</a></p><p><a href="https://www.infoq.cn/article/ikqw6fsidfcmqk2uqmwo">如何打造可以无限扩展的分布式消息队列?-InfoQ</a></p><p><a href="[queue - Difference between stream processing and message processing - Stack Overflow](https://stackoverflow.com/questions/41744506/difference-between-stream-processing-and-message-processing)">difference-between-stream-processing-and-message-processing</a></p><p><a href="https://www.packtpub.com/product/rabbitmq-essentials/9781783983209">What is messaging?</a></p><p><a href="[Apache BookKeeper™ - DistributedLog](https://sijie.github.io/bookkeeper-staging-site/docs/4.6.1/api/distributedlog-api/)">Distribute Log</a></p><p><a href="https://www.slidestalk.com/ApachePulsar/PulsarStreamNativeJia4336272">Apache Pulsar 从消息系统到流原生平台-Jia</a></p><p><a href="https://www.bilibili.com/video/BV1Tf4y1s7T9/">System Design - Message Queue</a></p></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="http://localhost:4000/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2022/01/01/Talk-About-Message-Queue/', clientID: 'Ov23li6FmCJDmAIlZmNK', clientSecret: '81bd012195b582aa2cabb7d2d472dd173353beef', repo: 'blog-comments', owner: 'HeroesZheng', admin: ['HeroesZheng'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="http://localhost:4000/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="DempeZheng">DempeZheng</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="http://localhost:4000/" title="首页" target="">首页</a></li><li> <a href="http://localhost:4000/categories/" title="分类" target="">分类</a></li><li> <a href="http://localhost:4000/wiki/" title="维基" target="">维基</a></li><li> <a href="http://localhost:4000/links/" title="链接" target="">链接</a></li><li> <a href="http://localhost:4000/about/" title="关于" target="">关于</a></li><li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="http://localhost:4000/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'G-RWCQYNELFN', 'auto'); ga('send', 'pageview'); </script></div></body></html>
