<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>关于磁盘IO的那些事 &mdash; dolphin</title><link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css"><link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="stylesheet" href="http://localhost:4000/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="http://localhost:4000/2022/03/03/Disk-IO-subsystem/"><link rel="alternate" type="application/atom+xml" title="dolphin" href="http://localhost:4000/feed.xml"><link rel="shortcut icon" href="http://localhost:4000/favicon.png"><meta property="og:title" content="关于磁盘IO的那些事"><meta name="keywords" content="IO, Java, 磁盘, 文件系统"><meta name="og:keywords" content="IO, Java, 磁盘, 文件系统"><meta name="description" content="一、Disk I/O subsystem概览"><meta name="og:description" content="一、Disk I/O subsystem概览"><meta property="og:url" content="http://localhost:4000/2022/03/03/Disk-IO-subsystem/"><meta property="og:site_name" content="dolphin"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2022-03-03"><title>关于磁盘IO的那些事 | dolphin</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="关于磁盘IO的那些事" /><meta name="author" content="DempeZheng" /><meta property="og:locale" content="en_US" /><meta name="description" content="some word here" /><meta property="og:description" content="some word here" /><link rel="canonical" href="http://localhost:4000/2022/03/03/Disk-IO-subsystem/" /><meta property="og:url" content="http://localhost:4000/2022/03/03/Disk-IO-subsystem/" /><meta property="og:site_name" content="dolphin" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-03T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="关于磁盘IO的那些事" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"DempeZheng"},"dateModified":"2022-03-03T00:00:00+08:00","datePublished":"2022-03-03T00:00:00+08:00","description":"some word here","headline":"关于磁盘IO的那些事","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2022/03/03/Disk-IO-subsystem/"},"url":"http://localhost:4000/2022/03/03/Disk-IO-subsystem/"}</script> <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="http://localhost:4000/assets/js/jquery-ui.js"></script> <script src="http://localhost:4000/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-RWCQYNELFN"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-RWCQYNELFN'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1> <a href="http://localhost:4000/" title="dolphin"> <span class="octicon octicon-mark-github"></span> dolphin </a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="http://localhost:4000/" class="site-header-nav-item" target="_self" title="📰首页"> <i class="octicon octicon-home"></i> 📰首页 </a> <a href="http://localhost:4000/categories/" class="site-header-nav-item" target="_self" title="分类"> <i class="octicon octicon-book"></i> 分类 </a> <a href="http://localhost:4000/wiki/" class="site-header-nav-item" target="_self" title="维基"> <i class=""></i> 维基 </a> <a href="http://localhost:4000/links/" class="site-header-nav-item" target="_self" title="链接"> <i class="octicon octicon-mail"></i> 链接 </a> <a href="http://localhost:4000/about/" class="site-header-nav-item" target="_self" title="关于"> <i class="octicon octicon-person"></i> 关于 </a> <a class="mobile-hidden" href="http://localhost:4000/feed.xml" title="订阅 RSS"> <i class="octicon octicon-rss" style="color:orange;"></i> </a></nav></div></header><section class="collection-head small " data-pattern-id="55"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">关于磁盘IO的那些事</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2022/03/03 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#技术" title="技术">技术</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 3522 字，约 11 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h2 id="一disk-io-subsystem概览">一、Disk I/O subsystem概览</h2><p><img src="https://www.thomas-krenn.com/de/wikiDE/images/e/e0/Linux-storage-stack-diagram_v4.10.png" alt="" /></p><p><img src="http://localhost:4000/images/2022-03-03-16-14-26-image.png" alt="" /></p><p><img src="https://i.stack.imgur.com/kiP8n.png" alt="" /></p><h2 id="二linux-io-自顶向下过程">二、Linux I/O 自顶向下过程</h2><p><img src="https://sean10.github.io/2021/09/08/IO%E8%B7%AF%E5%BE%84%E6%B5%81%E5%90%91%E5%88%9D%E6%8E%A2/IO%E8%B7%AF%E5%BE%84%E6%B5%81%E5%90%91%E5%B0%8F%E8%AE%B0_2020-12-05-01-11-50.png" alt="" /></p><h2 id="三io--subsystem-architecture">三、I/O subsystem architecture</h2><p><img src="https://liaoph.com/img/in-post/linux-system-io/io-arch.png" alt="" /></p><p>上图概括了一次磁盘 write 操作的过程，假设文件已经被从磁盘中读入了 page cache 中</p><ol><li><p>一个用户进程通过 write() 系统调用发起写请求</p></li><li><p>内核更新对应的 page cache</p></li><li><p>pdflush 内核线程将 page cache 写入至磁盘中</p></li><li><p>文件系统层将每一个 block buffer 存放为一个 bio 结构体，并向块设备层提交一个写请求</p></li><li><p>块设备层从上层接受到请求，执行 IO 调度操作，并将请求放入IO 请求队列中</p></li><li><p>设备驱动（如 SCSI 或其他设备驱动）完成写操作</p></li><li><p>磁盘设备固件执行对应的硬件操作，如磁盘的旋转，寻道等，数据被写入到磁盘扇区中</p></li></ol><h3 id="vfsfile-system-layer">VFS/File System Layer</h3><h4 id="虚拟文件系统">虚拟文件系统</h4><p>VFS（Virtual File System）：屏蔽下层具体文件系统操作的差异，为上层操作提供一个统一的接口。</p><ul><li><p>超级块（Super Block）</p></li><li><p>索引节点（Inode）</p></li><li><p>目录项（Dentry）</p></li><li><p>文件对象（File）</p></li></ul><p><img src="https://liaoph.com/img/in-post/linux-system-io/vfs.png" alt="" /></p><h4 id="page-cache-layer">Page Cache Layer</h4><p>在Linux的实现中，文件Cache分为两个层面，一是Page Cache，另一个Buffer Cache，每一个Page Cache包含若干Buffer Cache</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9sZGF5LW1lLTEyNTc5MDYwNTguY29zLmFwLXNoYW5naGFpLm15cWNsb3VkLmNvbS8wMDIzX2xpbnV4X3BhZ2VfY2FjaGVfYW5kX2J1ZmZlcl9jYWNoZS9pbWcvMjhfbGludXgtMi42LjE4X3BhZ2VfY2FjaGVfYnVmZmVyX2NhY2hlLnBuZw?x-oss-process=image/format,png" alt="" /></p><h3 id="block-layer">Block Layer</h3><p>Block layer 处理所有和块设备相关的操作。block layer 最关键是数据结构是 bio 结构体。bio 结构体是 file system layer 到 block layer 的接口。 当执行一个写操作时，文件系统层将数据写入 page cache（由 block buffer 组成），将连续的块放到一起，组成 bio 结构体，然后将 bio 送至 block layer。</p><p><img src="https://image.ldbmcs.com/2021-03-22-rA5r5y.jpg" alt="" /></p><p>block layer 处理 bio 请求，并将这些请求链接成一个队列，称作 IO 请求队列，这个连接的操作就称作 IO 调度（也叫 IO elevator 即电梯算法）.</p><h4 id="io-sheduler">IO sheduler</h4><p>IO 调度器的总体目标是减少磁盘的寻道时间（因此调度器都是针对机械硬盘进行优化的），IO 调度器通过两种方式来减少磁盘寻道：<strong>合并</strong>和<strong>排序</strong>。</p><p>调度器的算法和电梯运行的策略相似，因此 IO 调度器也被称作 IO 电梯( IO Elevator )。由于对请求进行了重排，一部分的请求可能会被延迟，以提升整体的性能。</p><ul><li><p>Linus Elevator</p></li><li><p>Deadline - latency-oriented</p></li><li><p>Anticipatory(AS)</p></li><li><p>Complete Fair Queuing(CFQ) - faireness-oriented</p></li><li><p>NOOP(No Operationo)</p></li></ul><h3 id="disk-device">Disk device</h3><p>机械磁盘性能影响因素</p><ul><li><p><code class="language-plaintext highlighter-rouge">Tseek</code>寻道时间（一般在3~15ms）</p></li><li><p><code class="language-plaintext highlighter-rouge">Trotation</code>旋转延迟</p></li><li><p><code class="language-plaintext highlighter-rouge">Transfer</code>数据传输时间</p></li></ul><h2 id="四java-io">四、Java IO</h2><p><img src="https://www.0xffffff.org/images/41/linux-io.png" alt="" /></p><h3 id="buffer-io">Buffer IO</h3><p>适用于普通类型的文件读写，性能尚可，操作简单，无注意事项。</p><h3 id="mmap">MMAP</h3><p><img src="https://www.linuxjournal.com/files/linuxjournal.com/linuxjournal/articles/063/6345/6345f2.jpg" alt="" /></p><ul><li><p>优点</p><ul><li>小数据量的读写性能极高</li></ul></li><li><p>缺点</p><ul><li><p>映射的大小最好4k对齐</p></li><li><p>释放麻烦</p></li><li><p>只能定长</p></li><li><p>随机写频繁的场景下，性能不一定比Buffer IO快</p></li></ul></li></ul><h3 id="direct-io">Direct IO</h3><p>需要自己控制Cache时，可以适用Direct IO，例如数据库/中间件应用，可以避免文件的读写还经过一层Page Cache，造成额外开销。</p><ul><li><p>在 open 時下的參數，允許用戶直接繞過 Linux kernel’s caches (Page Cache) 直接從用戶空間傳遞接收 data 到 disk。</p></li><li><p>可以减少复制</p></li><li><p>可能会降低性能，kernel对于缓存做的优化会失效，例如read_ahead</p></li></ul><h2 id="五-zero-copy">五、 Zero Copy</h2><p>传统文件传输的缺陷</p><ul><li><p>四次拷贝</p></li><li><p>用户态和内核态切换</p></li></ul><p><img src="https://s3.us.cloud-object-storage.appdomain.cloud/developer/default/articles/j-zerocopy/images/figure1.gif" alt="Traditional data copying approach" /></p><ul><li><p>DMA：直接内存访问（<em>Direct Memory Access</em>）技术</p><ul><li>在进行 I/O 设备和内存的数据传输的时候，数据搬运的工作全部交给 DMA 控制器，而 CPU 不再参与任何与数据搬运相关的事情，这样 CPU 就可以去处理别的事务</li></ul></li><li><p>NIC Buffer： Network Interface Controller Buffer</p></li></ul><p><img src="https://s3.us.cloud-object-storage.appdomain.cloud/developer/default/articles/j-zerocopy/images/figure2.gif" alt="Traditional context switches" /></p><h3 id="first-optmization">First optmization</h3><p><img src="https://forum.huawei.com/enterprise/en/data/attachment/forum/201905/24/152342tio7forhklj3luub.png?Zero%20copy3.png" alt="152342tio7forhklj3luub.png?Zero%20copy3." /></p><ul><li>TransferTo：Java支持zero copy的函数，底层是sendfile</li></ul><p><img src="https://forum.huawei.com/enterprise/en/data/attachment/forum/201905/24/152348gsitiirtrsfycvrh.png?Zero%20copy4.png" alt="152348gsitiirtrsfycvrh.png?Zero%20copy4." /></p><h3 id="second-optimization">Second optimization</h3><p><img src="https://forum.huawei.com/enterprise/en/data/attachment/forum/201905/24/152400j83v30drr3oc77d5.png?Zero%20copy5.png" alt="152400j83v30drr3oc77d5.png?Zero%20copy5." /></p><ul><li>Descriptor：文件描述符<ol><li>the DMA engine copies the contents of the file to the read buffer;</li></ol></li></ul><ol><li><strong>Only the information descriptor of the position and length of the data is appended to the socket buffer</strong>. DMA directly copies the data from the read buffer to the NIC buffer; thus omitting the CPU copy;</li></ol><h4 id="mmap-1">mmap</h4><p>mmap 是 Linux 提供的一种内存映射文件的机制，它实现了将内核中读缓冲区地址与用户空间缓冲区地址进行映射，从而实现内核缓冲区与用户缓冲区的共享。 这样就减少了一次用户态和内核态的 CPU 拷贝，但是在内核空间内仍然有一次 CPU 拷贝。</p><p>mmap 对大文件传输有一定优势，但是小文件可能出现碎片，并且在多个进程同时操作文件时可能产生引发 coredump 的 signal。</p><h2 id="六基于磁盘io的设计与调优">六、基于磁盘I/O的设计与调优</h2><h3 id="基于磁盘io的设计优化">基于磁盘I/O的设计优化</h3><h4 id="采用追加写">采用追加写</h4><ul><li><p>数据是被整体访问，比如HDFS</p></li><li><p>知道文件明确的偏移量，比如kafka</p></li><li><p>日志结构合并树LSM，比如HBase，LevelDB</p></li></ul><h4 id="文件合并和元数据优化">文件合并和元数据优化</h4><p>目前的大多数文件系统，如XFS/Ext4、GFS、HDFS，在元数据管理、缓存管理等实现策略上都侧重大文件</p><ul><li><p>小文件合并</p></li><li><p>元数据管理优化</p></li></ul><h3 id="基于磁盘io的参数调优">基于磁盘I/O的参数调优</h3><ul><li><p>IO调度队列长度</p><ul><li><p>/sys/block//queue/nr_requests</p></li><li><p>默认128，一般不建议修改</p></li></ul></li><li><p>read-ahead预读</p></li></ul><blockquote><p>预读量的默认值为512扇区，即256KB。用户可以使用cat命令查询当前块设备预读量。</p></blockquote><blockquote><p>linux-ob3a:~ # cat /sys/block/sdc/queue/read_ahead_kb 512</p></blockquote><h2 id="七io的指标与监控">七、IO的指标与监控</h2><ul><li>IOPS</li></ul><p>每秒的输入输出量(或读写次数)，也就是在一秒内，磁盘进行多少次 I/O 读写。是衡量磁盘性能的主要指标之一。</p><ul><li>吞吐量</li></ul><p>指单位时间内可以成功传输的数据数量。即磁盘写入加上读出的数据的大小。吞吐量等于IOPS乘以每次IO大小。</p><ul><li>使用率</li></ul><p>使用率，是指磁盘处理I/O的时间百分比，也就是一个时间段内磁盘用于处理IO的时间占这段时间的比例。过高的使用率(比如超过80% ) , 通常意味着磁盘I/O存在性能瓶颈。</p><ul><li>饱和度</li></ul><p>饱和度，是指磁盘处理I/O的繁忙程度，也就是能否接受新的IO请求。过高的饱和度,意味着磁盘存在严重的性能瓶颈。当饱和度为100%时,磁盘无法接受新的I/O请求。</p><ul><li>响应时间</li></ul><p>响应时间,是指I/O请求从发出到收到响应的间隔时间。</p><h3 id="性能监测工具提供的指标">性能监测工具提供的指标</h3><table><thead><tr><th>性能工具</th><th>性能指标</th></tr></thead><tbody><tr><td>iostat</td><td>磁盘I/O使用率、IOPS、 吞吐量、响应时间、I/O平均大小以及等待队列长度</td></tr><tr><td>pidstat</td><td>进程I/O大小以及I/O延迟</td></tr><tr><td>sar</td><td>磁盘I/O使用率、IOPS 、吞吐量以及响应时间</td></tr><tr><td>dstat</td><td>磁盘I/O使用率、IOPS以及吞吐量</td></tr><tr><td>iotop</td><td>按I/O大小对进程排序</td></tr><tr><td>slabtop</td><td>目录项、索引节点以及文件系统的缓存</td></tr><tr><td>/proc/slabinfo</td><td>目录项、索引节点以及文件系统的缓存</td></tr><tr><td>/proc/meminfo</td><td>页缓存和可回收Slab缓存</td></tr><tr><td>/proc/diskstats</td><td>磁盘的IOPS、吞吐量以及延迟!</td></tr><tr><td>/proc/pid/io</td><td>进程IOPS、IO大小以及IO延迟</td></tr><tr><td>vmstat</td><td>缓存和缓冲区用量汇总</td></tr><tr><td>blktrace</td><td>跟踪块设备I/O事件</td></tr><tr><td>biosnoop</td><td>跟踪进程的块设备I/O大小</td></tr><tr><td>biotop</td><td>跟踪进程块I/O并按I/O大小排序</td></tr><tr><td>strace</td><td>跟踪进程的I/O系统调用</td></tr><tr><td>perf</td><td>跟踪内核中的I/O事件</td></tr><tr><td>df</td><td>磁盘空间和索引节点使用量和剩余量</td></tr><tr><td>mount</td><td>文件系统的挂载路径以及挂载参数</td></tr><tr><td>du</td><td>目录占用的磁盘空间大小</td></tr><tr><td>tune2fs</td><td>显示和设置文件系统参数</td></tr><tr><td>hdparam</td><td>显示和设置磁盘参数</td></tr></tbody></table><h2 id="八faq">八、FAQ</h2><ul><li><p>描述下数据写入磁盘的过程，</p></li><li><p>说说zero copy技术，以及应用场景</p></li></ul><h2 id="参考文档">参考文档</h2><p><a href="Linux perf Examples](https://www.brendangregg.com/perf.html)"># Linux Perf</a></p><p><a href="https://sean10.github.io/2021/09/08/IO%E8%B7%AF%E5%BE%84%E6%B5%81%E5%90%91%E5%88%9D%E6%8E%A2/"># IO路径流向初探 行路中. 脚踏实地</a></p><p><a href="http://kerneltravel.net/blog/2020/io_sys_szp_no2/"># I/O设备吞吐量与延迟简介</a></p><p><a href="http://embeddedsystemforu.blogspot.com/2013/08/glimpses-of-device-drivers.html"># Embedded System: Glimpses of Device drivers</a></p><p><a href="https://blog.csdn.net/jinking01/article/details/107480248"># Linux内核Page Cache和Buffer Cache关系及演化历史_jinking01的专栏-CSDN博客</a></p><p><a href="https://liaoph.com/linux-system-io/"># Linux 性能优化之 IO 子系统 - Fantasy</a><a href="https://liaoph.com/linux-system-io/">Linux 性能优化之 IO 子系统 - Fantasy</a></p><p><a href="https://www.i4k.xyz/article/universsky2015/100528640"># 内存映射文件 mmap 原理深度剖析_禅与计算机程序设计艺术-程序员信息网 - 程序员信息网</a></p><p><a href="http://hushi55.github.io/2015/10/22/linux-network-stack"># linux network stack</a></p></article><div class="share"><div class="share-component" data-disabled='qq,douban,qzone,linkedin'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="http://localhost:4000/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2022/03/03/Disk-IO-subsystem/', clientID: 'Ov23li6FmCJDmAIlZmNK', clientSecret: '81bd012195b582aa2cabb7d2d472dd173353beef', repo: 'blog-comments', owner: 'HeroesZheng', admin: ['HeroesZheng'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="http://localhost:4000/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="DempeZheng">DempeZheng</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="http://localhost:4000/" title="📰首页" target="">📰首页</a></li><li> <a href="http://localhost:4000/categories/" title="分类" target="">分类</a></li><li> <a href="http://localhost:4000/wiki/" title="维基" target="">维基</a></li><li> <a href="http://localhost:4000/links/" title="链接" target="">链接</a></li><li> <a href="http://localhost:4000/about/" title="关于" target="">关于</a></li><li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="http://localhost:4000/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="http://localhost:4000/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
